<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ThingsBoard Neural Interface</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500&family=Space+Grotesk:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Palette: Acid Industrial */
        --bg-deep: #050505;
        --surface-dark: #0a0a0a;
        --surface-light: #161616;

        --accent-acid: #d4f34a; /* Acid Lime */
        --accent-glow: rgba(212, 243, 74, 0.4);

        --text-primary: #ededed;
        --text-secondary: #888888;

        --border-subtle: rgba(255, 255, 255, 0.08);

        --font-head: "Space Grotesk", sans-serif;
        --font-body: "Outfit", sans-serif;

        --unit: 8px;
      }

      * {
        box-sizing: border-box;
      }



      /* Ambient visuals removed */
      
      .fab-trigger, .interface-container {
          pointer-events: auto; /* Re-enable clicks on UI elements */
      }

      /* FAB / Trigger */
      .fab-trigger {
        position: fixed;
        bottom: 40px;
        right: 40px;
        width: 72px;
        height: 72px;
        background: var(--surface-light);
        border: 1px solid var(--border-subtle);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
        transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        box-shadow: 0 0 0 0 var(--accent-glow);
      }

      .fab-trigger:hover {
        transform: scale(1.05);
        border-color: var(--accent-acid);
        box-shadow: 0 0 20px -5px var(--accent-glow);
      }

      .fab-trigger svg {
        fill: var(--text-primary);
        width: 28px;
        height: 28px;
        transition: fill 0.3s;
      }

      .fab-trigger:hover svg {
        fill: var(--accent-acid);
      }

      .fab-trigger.active {
        background: var(--accent-acid);
        transform: rotate(45deg);
        border-color: var(--accent-acid);
      }

      .fab-trigger.active svg {
        fill: black;
      }

      /* Main Interface */
      .interface-container {
        position: fixed;
        bottom: 130px;
        right: 40px;
        width: 400px;
        height: 650px;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--border-subtle);
        border-radius: 24px;
        display: flex;
        flex-direction: column;
        overflow: hidden;

        /* Entry Animation */
        opacity: 0;
        transform: translateY(40px) scale(0.96);
        pointer-events: none;
        transition: opacity 0.4s ease,
          transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);

        box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.05) inset;
      }

      .interface-container.active {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: all;
      }

      /* Header */
      header {
        padding: 24px 24px 16px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .brand h1 {
        font-family: var(--font-head);
        font-size: 18px;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.02em;
        color: var(--text-primary);
      }

      .brand span {
        display: block;
        font-family: var(--font-body);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--accent-acid);
        margin-top: 4px;
        font-weight: 500;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        background: var(--border-subtle);
        border-radius: 50%;
        margin-top: 6px;
        box-shadow: 0 0 0 2px var(--bg-deep);
      }

      .status-dot.online {
        background: var(--accent-acid);
        box-shadow: 0 0 10px var(--accent-acid);
      }

      /* Chat Area */
      .terminal-window {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        scroll-behavior: smooth;
      }

      /* Scrollbar */
      .terminal-window::-webkit-scrollbar {
        width: 4px;
      }
      .terminal-window::-webkit-scrollbar-track {
        background: transparent;
      }
      .terminal-window::-webkit-scrollbar-thumb {
        background: var(--surface-light);
        border-radius: 4px;
      }

      /* Messages */
      .msg-row {
        display: flex;
        align-items: flex-end;
        margin-bottom: 4px;
        opacity: 0;
        transform: translateY(10px);
        animation: slideUp 0.3s cubic-bezier(0.19, 1, 0.22, 1) forwards;
      }

      @keyframes slideUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .msg-row.user {
        justify-content: flex-end;
      }

      .msg-bubble {
        max-width: 85%;
        padding: 14px 18px;
        font-size: 14px;
        line-height: 1.5;
        position: relative;
      }

      /* Bot Style */
      .msg-row.bot .msg-bubble {
        background: var(--surface-light);
        color: #d4d4d4;
        border-radius: 4px 18px 18px 18px;
        border: 1px solid var(--border-subtle);
      }

      .msg-row.bot .msg-bubble::before {
        content: "";
        position: absolute;
        left: -4px;
        bottom: 0;
        width: 4px;
        height: 100%;
        background: var(--accent-acid);
        border-radius: 2px 0 0 2px;
        opacity: 0.5;
      }

      /* User Style */
      .msg-row.user .msg-bubble {
        background: var(--text-primary);
        color: var(--bg-deep);
        border-radius: 18px 18px 4px 18px;
        font-family: var(--font-head);
        font-weight: 500;
      }

      /* Chart Container */
      canvas {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 10px;
        margin-top: 12px;
        border: 1px solid var(--border-subtle);
      }

      /* Input Area */
      .input-dock {
        padding: 20px;
        background: rgba(10, 10, 10, 0.8);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--border-subtle);
      }

      .input-wrapper {
        background: var(--surface-light);
        border: 1px solid var(--border-subtle);
        border-radius: 30px;
        padding: 6px 6px 6px 20px;
        display: flex;
        align-items: center;
        transition: border-color 0.2s;
      }

      .input-wrapper:focus-within {
        border-color: var(--accent-acid);
      }

      input {
        flex: 1;
        background: transparent;
        border: none;
        color: white;
        font-family: var(--font-body);
        font-size: 14px;
        outline: none;
      }

      input::placeholder {
        color: #555;
      }

      .btn-icon {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: none;
        background: transparent;
        color: #777;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .btn-icon:hover {
        color: white;
        background: rgba(255, 255, 255, 0.05);
      }

      .btn-send {
        background: var(--text-primary);
        color: black;
      }

      .btn-send:hover {
        background: var(--accent-acid);
        transform: scale(1.05);
      }

      .mic-active {
        color: #ef4444 !important;
        animation: pulse-mic 1.5s infinite;
      }

      @keyframes pulse-mic {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.7;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Typing Indicator */
      .typing {
        font-family: "Space Grotesk", monospace;
        font-size: 10px;
        color: var(--accent-acid);
        text-transform: uppercase;
        padding-left: 24px;
        margin-bottom: 20px;
        letter-spacing: 0.1em;
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .typing.visible {
        opacity: 1;
      }

      .scan-line {
        width: 20px;
        height: 2px;
        background: var(--accent-acid);
        animation: scan 1s infinite linear;
      }

      @keyframes scan {
        0% {
          transform: translateX(0);
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          transform: translateX(10px);
          opacity: 0;
        }
      }

      /* Mobile Responsive */
      @media (max-width: 480px) {
        .interface-container {
          width: 90%;
          right: 5%;
          bottom: 100px;
          height: 70vh;
        }
      }
    </style>
  </head>
  <body>
    <!-- Ambient visuals removed for transparency -->

    <!-- Trigger -->
    <div class="fab-trigger" id="fabBtn" onclick="toggleInterface()">
      <svg viewBox="0 0 24 24">
        <path
          d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"
        />
      </svg>
    </div>

    <!-- Interface -->
    <div class="interface-container" id="uiContainer">
      <header>
        <div class="brand">
          <h1>SAI</h1>
          <span>Device are Connected</span>
        </div>
        <div class="status-dot online" id="statusDot"></div>
      </header>

      <div class="terminal-window" id="messageLog">
        <!-- Initial Message -->
        <div class="msg-row bot">
          <div class="msg-bubble">
            <strong>System Online.</strong><br />
            Telemetry stream active. Ask about battery status, alerts, or
            request data visualization.
          </div>
        </div>
      </div>

      <div class="typing" id="typingIndicator">
        <div class="scan-line"></div>
        Processing Query...
      </div>

      <div class="input-dock">
        <div class="input-wrapper">
          <button class="btn-icon" id="micBtn" onclick="toggleMic()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"
              />
              <path
                d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"
              />
            </svg>
          </button>
          <input
            type="text"
            id="userInput"
            placeholder="Enter command..."
            autocomplete="off"
          />
          <button class="btn-icon btn-send" onclick="sendMessage()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      const uiContainer = document.getElementById("uiContainer");
      const fab = document.getElementById("fabBtn");
      const messageLog = document.getElementById("messageLog");
      const userInput = document.getElementById("userInput");
      const typingIndicator = document.getElementById("typingIndicator");
      const micBtn = document.getElementById("micBtn");

      // Toggle Interface
      function toggleInterface() {
        uiContainer.classList.toggle("active");
        fab.classList.toggle("active");
        if (uiContainer.classList.contains("active")) userInput.focus();
      }

      // Handle Enter Key
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // Speech Recognition
      let recognition;
      if ("webkitSpeechRecognition" in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.lang = "en-US";

        recognition.onstart = () => {
          micBtn.classList.add("mic-active");
          userInput.placeholder = "Listening to voice command...";
        };

        recognition.onend = () => {
          micBtn.classList.remove("mic-active");
          userInput.placeholder = "Enter command...";
        };

        recognition.onresult = (event) => {
          userInput.value = event.results[0][0].transcript;
          sendMessage();
        };
      } else {
        micBtn.style.display = "none";
      }

      function toggleMic() {
        if (!recognition) return;
        if (micBtn.classList.contains("mic-active")) recognition.stop();
        else recognition.start();
      }

      // Proactive Alerts
      setInterval(async () => {
        try {
          const res = await fetch("/alerts");
          const data = await res.json();
          const statusDot = document.getElementById("statusDot");

          if (data.has_alert) {
            statusDot.style.background = "#ef4444";
            statusDot.style.boxShadow = "0 0 10px #ef4444";
            // Could auto-open or show badge
          } else {
            statusDot.style.background = "var(--accent-acid)";
            statusDot.style.boxShadow = "0 0 10px var(--accent-acid)";
          }
        } catch (e) {}
      }, 10000);

      // Core Messaging Logic
      async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        addMessage(text, "user");
        userInput.value = "";

        typingIndicator.classList.add("visible");
        scrollToBottom();

        try {
          const response = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: text }),
          });

          const data = await response.json();
          typingIndicator.classList.remove("visible");

          if (data.response) {
            addMessage(data.response, "bot", data.chart);
          } else {
            addMessage("Communication Error: No response data.", "bot");
          }
        } catch (error) {
          typingIndicator.classList.remove("visible");
          addMessage("System Error: Connection failed.", "bot");
        }
      }

      function addMessage(text, sender, chartData = null) {
        const row = document.createElement("div");
        row.className = `msg-row ${sender}`;

        const bubble = document.createElement("div");
        bubble.className = "msg-bubble";

        if (sender === "bot") {
          bubble.innerHTML = marked.parse(text);
          if (chartData) {
            const canvas = document.createElement("canvas");
            canvas.id = `chart_${Date.now()}`;
            bubble.appendChild(canvas);
            setTimeout(() => renderChart(canvas.id, chartData), 50);
          }
        } else {
          bubble.textContent = text;
        }

        row.appendChild(bubble);
        messageLog.appendChild(row);
        scrollToBottom();
      }

      function scrollToBottom() {
        messageLog.scrollTop = messageLog.scrollHeight;
      }

      // Modern Chart Config
      function renderChart(canvasId, data) {
        const ctx = document.getElementById(canvasId).getContext("2d");

        // Create Gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, "rgba(212, 243, 74, 0.5)"); // Acid color
        gradient.addColorStop(1, "rgba(212, 243, 74, 0.0)");

        new Chart(ctx, {
          type: "line",
          data: {
            labels: data.points.map((p) => new Date(p.t).toLocaleTimeString()),
            datasets: [
              {
                label: data.label,
                data: data.points.map((p) => p.y),
                borderColor: "#D4F34A",
                backgroundColor: gradient,
                borderWidth: 2,
                pointBackgroundColor: "#000",
                pointBorderColor: "#D4F34A",
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "rgba(10,10,10,0.9)",
                titleColor: "#D4F34A",
                bodyColor: "#fff",
                borderColor: "#333",
                borderWidth: 1,
              },
            },
            scales: {
              x: {
                display: false,
                grid: { display: false },
              },
              y: {
                grid: { color: "rgba(255,255,255,0.05)" },
                ticks: { color: "#666", font: { family: "Outfit", size: 10 } },
              },
            },
          },
        });
      }
    </script>
  </body>
</html>
